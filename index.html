<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moonlit Fiction ‚Äî Mini Book Shop (GA4 Training)</title>
  <meta name="description" content="A simple static e-commerce demo site for GA4 training. Fiction books, cart, checkout, purchase events." />

  <!-- =========================
       GA4 (gtag.js) ‚Äî TRAINING
       Replace G-XXXXXXXXXX with your GA4 Measurement ID.
       ========================= -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    // Basic config
    gtag('config', 'G-XXXXXXXXXX', {
      debug_mode: true // set false when done testing
    });
  </script>

  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --muted:#9fb0ff;
      --text:#e9eeff;
      --accent:#7c5cff;
      --accent2:#2fe3c0;
      --danger:#ff4d6d;
      --line:rgba(255,255,255,.12);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 22px;
      --max: 1100px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(124,92,255,.28), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(47,227,192,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:26px 18px 80px;}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:18px 18px;
      background: rgba(18,26,51,.75);
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 10px;
      z-index: 20;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      text-decoration:none;
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(47,227,192,.9));
      box-shadow: 0 10px 22px rgba(124,92,255,.25);
      display:grid; place-items:center;
      font-weight:800;
    }
    .brand h1{font-size:16px; margin:0; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:rgba(233,238,255,.72)}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      font-size:13px;
    }
    .pill strong{font-family:var(--mono); font-weight:700}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:650;
      letter-spacing:.2px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(124,92,255,.55));
      border-color: rgba(124,92,255,.55);
    }
    .btn.primary:hover{filter: brightness(1.05)}
    .btn.good{
      background: linear-gradient(135deg, rgba(47,227,192,.95), rgba(47,227,192,.45));
      border-color: rgba(47,227,192,.55);
      color:#07101b;
    }
    .btn.danger{
      background: rgba(255,77,109,.12);
      border-color: rgba(255,77,109,.35);
      color: var(--text);
    }

    .hero{
      margin-top: 18px;
      padding: 26px 18px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(18,26,51,.55);
      box-shadow: var(--shadow);
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:18px;
    }
    .hero h2{margin:0; font-size:28px; line-height:1.1}
    .hero p{margin:10px 0 0; color: rgba(233,238,255,.78); max-width: 62ch}
    .hero .note{
      margin-top: 12px;
      padding: 12px 12px;
      border: 1px dashed rgba(159,176,255,.45);
      border-radius: 14px;
      background: rgba(159,176,255,.08);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(233,238,255,.85);
    }
    .hero .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      padding: 14px;
      display:flex; flex-direction:column; gap:10px;
      align-self: start;
    }
    .hero .panel h3{margin:0; font-size:14px}
    .hero .panel ul{margin:0; padding-left: 18px; color: rgba(233,238,255,.78); font-size:13px}
    .hero .panel li{margin: 6px 0}

    .controls{
      margin-top: 16px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .search{
      flex:1;
      min-width: 220px;
      display:flex; align-items:center; gap:10px;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .search input{
      width:100%;
      background: transparent;
      border:0;
      outline:0;
      color: var(--text);
      font-size: 14px;
    }
    .select{
      display:flex; align-items:center; gap:10px;
      padding: 12px 14px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    select{
      background: transparent;
      border:0;
      outline:0;
      color: var(--text);
      font-size: 14px;
      appearance:none;
      cursor:pointer;
    }
    option{color:#0b1020}

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
    }
    .card{
      grid-column: span 4;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(18,26,51,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
      min-height: 320px;
    }
    .cover{
      height: 150px;
      display:flex; align-items:flex-end; justify-content:space-between;
      padding: 14px;
      background:
        radial-gradient(500px 200px at 20% 0%, rgba(124,92,255,.45), transparent 55%),
        radial-gradient(500px 200px at 80% 40%, rgba(47,227,192,.25), transparent 55%),
        rgba(255,255,255,.04);
      border-bottom:1px solid var(--line);
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(233,238,255,.90);
    }
    .price{
      font-family: var(--mono);
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 14px;
    }
    .content{
      padding: 14px;
      display:flex; flex-direction:column; gap:10px;
      flex:1;
    }
    .title{
      margin:0;
      font-size: 16px;
      line-height: 1.2;
    }
    .meta{
      font-size: 12px;
      color: rgba(233,238,255,.70);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .desc{
      margin: 0;
      font-size: 13px;
      color: rgba(233,238,255,.78);
      line-height: 1.45;
      flex:1;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }

    footer{
      margin-top: 24px;
      padding: 18px;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: rgba(18,26,51,.45);
      color: rgba(233,238,255,.76);
      font-size: 13px;
    }
    footer code{font-family:var(--mono); color: rgba(159,176,255,.95)}
    .small{font-size:12px; opacity:.85}

    /* Modal */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      max-width: 720px;
      width: 100%;
      border-radius: 22px;
      border:1px solid var(--line);
      background: rgba(18,26,51,.92);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal header{
      position: static;
      margin:0;
      border-radius: 0;
      border:0;
      border-bottom:1px solid var(--line);
      box-shadow: none;
      background: rgba(255,255,255,.04);
      backdrop-filter: none;
      padding: 14px 16px;
    }
    .modal .body{padding: 14px 16px}
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .table th,.table td{
      text-align:left;
      border-bottom:1px solid var(--line);
      padding: 10px 8px;
      vertical-align: top;
    }
    .table th{color: rgba(233,238,255,.85); font-weight: 750}
    .table td{color: rgba(233,238,255,.78)}
    .qty{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      font-family: var(--mono);
    }
    .qty button{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      width: 26px; height: 26px;
      border-radius: 999px;
      font-weight: 900;
    }
    .right{ text-align:right }
    .muted{ color: rgba(233,238,255,.68) }
    .toast{
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(18,26,51,.9);
      box-shadow: var(--shadow);
      display:none;
      z-index: 60;
      font-size: 13px;
      color: rgba(233,238,255,.86);
    }

    @media (max-width: 980px){
      .hero{grid-template-columns: 1fr}
      .card{grid-column: span 6}
    }
    @media (max-width: 640px){
      header{flex-direction:column; align-items:stretch}
      .actions{justify-content:space-between}
      .card{grid-column: span 12}
      .controls{flex-direction:column; align-items:stretch}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <a class="brand" href="#" id="homeLink" aria-label="Moonlit Fiction Home">
        <div class="logo">MF</div>
        <div>
          <h1>Moonlit Fiction</h1>
          <p>Mini bookstore ‚Ä¢ GA4 training demo</p>
        </div>
      </a>

      <div class="actions">
        <div class="pill" title="Cart items">
          üõí Cart <strong id="cartCount">0</strong>
        </div>
        <button class="btn" id="viewCartBtn" type="button">View cart</button>
        <button class="btn primary" id="beginCheckoutBtn" type="button">Checkout</button>
      </div>
    </header>

    <section class="hero" aria-label="Intro">
      <div>
        <h2>Fiction books, a tiny cart, and clean GA4 events.</h2>
        <p>
          This is a single-page, static ‚Äúe-commerce‚Äù site you can host on <strong>GitHub Pages</strong>.
          Use it to practice GA4: browse items, add to cart, checkout, and ‚Äúpurchase‚Äù (simulated).
        </p>

        <div class="note">
          Setup: replace <strong>G-XXXXXXXXXX</strong> in the GA4 snippet.
          Then watch events in GA4 DebugView (or browser console).
        </div>
      </div>

      <aside class="panel" aria-label="What this fires">
        <h3>Tracked interactions</h3>
        <ul>
          <li><strong>view_item</strong> when you open item details</li>
          <li><strong>add_to_cart</strong> for Add buttons</li>
          <li><strong>view_cart</strong> when cart opens</li>
          <li><strong>begin_checkout</strong> when checkout starts</li>
          <li><strong>purchase</strong> when you click ‚ÄúPlace order‚Äù</li>
        </ul>
        <div class="small muted">Tip: open DevTools Console to see debug logs.</div>
      </aside>
    </section>

    <section class="controls" aria-label="Filters">
      <div class="search" role="search">
        üîé
        <input id="searchInput" type="search" placeholder="Search titles, authors, genres‚Ä¶" />
      </div>

      <div class="select" aria-label="Sort">
        ‚ÜïÔ∏è
        <select id="sortSelect" aria-label="Sort books">
          <option value="featured">Sort: Featured</option>
          <option value="priceAsc">Price: Low ‚Üí High</option>
          <option value="priceDesc">Price: High ‚Üí Low</option>
          <option value="titleAsc">Title: A ‚Üí Z</option>
        </select>
      </div>

      <button class="btn" id="clearCartBtn" type="button">Clear cart</button>
    </section>

    <main class="grid" id="productGrid" aria-label="Products"></main>

    <footer>
      <div><strong>GA4 training notes</strong></div>
      <ul>
        <li>Replace <code>G-XXXXXXXXXX</code> with your Measurement ID.</li>
        <li>For DebugView: use GA4 DebugView or enable Tag Assistant / debug_mode.</li>
        <li>Events follow GA4 ecommerce structure using <code>items</code> arrays.</li>
      </ul>
      <div class="small muted">This is a demo site (no real payments). All checkout/purchase actions are simulated.</div>
    </footer>
  </div>

  <!-- CART / CHECKOUT MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Cart and checkout">
    <div class="modal">
      <header>
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; width:100%;">
          <div>
            <div style="font-weight:800;">Your cart</div>
            <div class="small muted" id="cartSubtitle">Review items and proceed to checkout.</div>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="btn danger" id="closeModalBtn" type="button">Close</button>
          </div>
        </div>
      </header>

      <div class="body">
        <div style="overflow:auto;">
          <table class="table" aria-label="Cart table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th class="right">Price</th>
                <th class="right">Line total</th>
              </tr>
            </thead>
            <tbody id="cartRows"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="muted small">
            Promo code field (for training): <span style="font-family:var(--mono);">WINTER10</span>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="pill">Total <strong id="cartTotal">‚Ç¨0.00</strong></div>
            <button class="btn good" id="placeOrderBtn" type="button">Place order (simulate)</button>
          </div>
        </div>

        <div class="small muted" style="margin-top:10px;">
          ‚ÄúPlace order‚Äù triggers a GA4 <code>purchase</code> event with transaction_id, value, currency, and items.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite"></div>

  <script>
    // =========================
    // Demo product catalog
    // =========================
    const CURRENCY = "EUR";
    const PRODUCTS = [
      {
        item_id: "BK-001",
        item_name: "The Clockwork Garden",
        item_brand: "Moonlit Press",
        item_category: "Fantasy",
        item_category2: "Cozy Fantasy",
        item_variant: "Paperback",
        price: 12.99,
        index: 1,
        featured: true,
        description: "A gentle fantasy about a gardener who grows time itself."
      },
      {
        item_id: "BK-002",
        item_name: "Neon Drift Chronicles",
        item_brand: "Moonlit Press",
        item_category: "Science Fiction",
        item_category2: "Cyberpunk",
        item_variant: "Hardback",
        price: 18.50,
        index: 2,
        featured: true,
        description: "A runaway courier outraces a city that never powers down."
      },
      {
        item_id: "BK-003",
        item_name: "Murder at Marigold Pier",
        item_brand: "Moonlit Press",
        item_category: "Mystery",
        item_category2: "Whodunit",
        item_variant: "Paperback",
        price: 10.75,
        index: 3,
        featured: true,
        description: "A seaside whodunit with secrets buried in the tide."
      },
      {
        item_id: "BK-004",
        item_name: "The Library of Lost Letters",
        item_brand: "Moonlit Press",
        item_category: "Romance",
        item_category2: "Historical Romance",
        item_variant: "Paperback",
        price: 11.25,
        index: 4,
        featured: false,
        description: "Two strangers uncover a century-old love story‚Äîthen write their own."
      },
      {
        item_id: "BK-005",
        item_name: "Ash & Oracle",
        item_brand: "Moonlit Press",
        item_category: "Fantasy",
        item_category2: "Epic Fantasy",
        item_variant: "Ebook",
        price: 6.99,
        index: 5,
        featured: false,
        description: "A rebel seer bargains with prophecy‚Äîand pays in fire."
      },
      {
        item_id: "BK-006",
        item_name: "The Quiet Between Stars",
        item_brand: "Moonlit Press",
        item_category: "Science Fiction",
        item_category2: "Space Opera",
        item_variant: "Paperback",
        price: 13.40,
        index: 6,
        featured: false,
        description: "A ship‚Äôs crew finds hope in the silence no sensor can map."
      }
    ];

    // =========================
    // Simple cart in localStorage
    // cart: { [item_id]: qty }
    // =========================
    const LS_KEY = "mf_cart_v1";

    function loadCart(){
      try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }
      catch { return {}; }
    }
    function saveCart(cart){
      localStorage.setItem(LS_KEY, JSON.stringify(cart));
      updateCartCount();
    }
    function clearCart(){
      localStorage.removeItem(LS_KEY);
      updateCartCount();
    }
    function getCartCount(){
      const cart = loadCart();
      return Object.values(cart).reduce((a,b) => a + b, 0);
    }

    // =========================
    // UI helpers
    // =========================
    const grid = document.getElementById("productGrid");
    const cartCountEl = document.getElementById("cartCount");
    const toastEl = document.getElementById("toast");

    function money(n){
      return new Intl.NumberFormat(undefined, { style:"currency", currency: CURRENCY }).format(n);
    }

    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = "none", 2200);
    }

    function updateCartCount(){
      cartCountEl.textContent = String(getCartCount());
    }

    // =========================
    // GA4 helpers (events)
    // =========================
    function gaEvent(name, params){
      try{
        console.log("[GA4 event]", name, params);
        gtag("event", name, params);
      }catch(e){
        console.log("gtag not available yet:", e);
      }
    }

    function buildItem(product, quantity=1){
      // GA4 item format: https://developers.google.com/analytics/devguides/collection/ga4/reference/events
      return {
        item_id: product.item_id,
        item_name: product.item_name,
        item_brand: product.item_brand,
        item_category: product.item_category,
        item_category2: product.item_category2,
        item_variant: product.item_variant,
        price: product.price,
        quantity: quantity,
        index: product.index
      };
    }

    // =========================
    // Render products
    // =========================
    function renderProducts(list){
      grid.innerHTML = "";
      list.forEach(p => {
        const card = document.createElement("article");
        card.className = "card";
        card.innerHTML = `
          <div class="cover">
            <span class="badge">${p.item_category}</span>
            <span class="price">${money(p.price)}</span>
          </div>
          <div class="content">
            <h3 class="title">${p.item_name}</h3>
            <div class="meta">
              <span>üè∑Ô∏è ${p.item_variant}</span>
              <span>üèõÔ∏è ${p.item_brand}</span>
              <span>‚ú® ${p.item_category2}</span>
            </div>
            <p class="desc">${p.description}</p>
            <div class="row">
              <button class="btn" data-action="details" data-id="${p.item_id}">View details</button>
              <button class="btn primary" data-action="add" data-id="${p.item_id}">Add to cart</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // =========================
    // Search/sort
    // =========================
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");

    function getFilteredSorted(){
      const q = (searchInput.value || "").toLowerCase().trim();
      let list = PRODUCTS.filter(p => {
        if(!q) return true;
        const hay = `${p.item_name} ${p.item_brand} ${p.item_category} ${p.item_category2} ${p.item_variant}`.toLowerCase();
        return hay.includes(q);
      });

      const sort = sortSelect.value;
      if(sort === "priceAsc") list.sort((a,b)=>a.price-b.price);
      else if(sort === "priceDesc") list.sort((a,b)=>b.price-a.price);
      else if(sort === "titleAsc") list.sort((a,b)=>a.item_name.localeCompare(b.item_name));
      else { // featured
        list.sort((a,b)=> Number(b.featured) - Number(a.featured) || a.index - b.index);
      }
      return list;
    }

    searchInput.addEventListener("input", () => renderProducts(getFilteredSorted()));
    sortSelect.addEventListener("change", () => renderProducts(getFilteredSorted()));

    // =========================
    // Product interactions
    // =========================
    grid.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if(!btn) return;

      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      const product = PRODUCTS.find(p => p.item_id === id);
      if(!product) return;

      if(action === "details"){
        // Fire view_item
        gaEvent("view_item", {
          currency: CURRENCY,
          value: product.price,
          items: [buildItem(product, 1)]
        });
        alert(
          `${product.item_name}\n\n` +
          `${product.description}\n\n` +
          `Format: ${product.item_variant}\n` +
          `Genre: ${product.item_category} ‚Ä¢ ${product.item_category2}\n` +
          `Price: ${money(product.price)}\n\n` +
          `GA4: view_item fired`
        );
      }

      if(action === "add"){
        const cart = loadCart();
        cart[id] = (cart[id] || 0) + 1;
        saveCart(cart);

        // Fire add_to_cart
        gaEvent("add_to_cart", {
          currency: CURRENCY,
          value: product.price,
          items: [buildItem(product, 1)]
        });

        showToast(`Added ‚Äú${product.item_name}‚Äù to cart`);
      }
    });

    // =========================
    // Cart modal + checkout
    // =========================
    const backdrop = document.getElementById("modalBackdrop");
    const viewCartBtn = document.getElementById("viewCartBtn");
    const beginCheckoutBtn = document.getElementById("beginCheckoutBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const clearCartBtn = document.getElementById("clearCartBtn");
    const cartRows = document.getElementById("cartRows");
    const cartTotalEl = document.getElementById("cartTotal");
    const placeOrderBtn = document.getElementById("placeOrderBtn");

    function openModal(mode){
      // mode: "view_cart" or "begin_checkout"
      renderCartTable();

      backdrop.style.display = "flex";

      const cart = loadCart();
      const items = Object.entries(cart).map(([id, qty]) => {
        const p = PRODUCTS.find(x => x.item_id === id);
        return buildItem(p, qty);
      });
      const value = calcCartTotal();

      if(mode === "view_cart"){
        gaEvent("view_cart", { currency: CURRENCY, value, items });
      } else if(mode === "begin_checkout"){
        gaEvent("begin_checkout", {
          currency: CURRENCY,
          value,
          coupon: "WINTER10",
          items
        });
      }
    }

    function closeModal(){
      backdrop.style.display = "none";
    }

    function calcCartTotal(){
      const cart = loadCart();
      let total = 0;
      for(const [id, qty] of Object.entries(cart)){
        const p = PRODUCTS.find(x => x.item_id === id);
        total += (p ? p.price : 0) * qty;
      }
      return Number(total.toFixed(2));
    }

    function renderCartTable(){
      const cart = loadCart();
      const rows = Object.entries(cart);

      if(rows.length === 0){
        cartRows.innerHTML = `
          <tr>
            <td colspan="4" class="muted">Your cart is empty. Add a book to practice ecommerce events.</td>
          </tr>
        `;
        cartTotalEl.textContent = money(0);
        return;
      }

      cartRows.innerHTML = rows.map(([id, qty]) => {
        const p = PRODUCTS.find(x => x.item_id === id);
        const line = (p.price * qty);
        return `
          <tr>
            <td>
              <div style="font-weight:800;">${p.item_name}</div>
              <div class="small muted">${p.item_category} ‚Ä¢ ${p.item_variant}</div>
              <div class="small muted" style="font-family:var(--mono);">${p.item_id}</div>
            </td>
            <td>
              <span class="qty" aria-label="Quantity controls">
                <button type="button" data-qty="dec" data-id="${id}" aria-label="Decrease quantity">‚àí</button>
                <span>${qty}</span>
                <button type="button" data-qty="inc" data-id="${id}" aria-label="Increase quantity">+</button>
              </span>
            </td>
            <td class="right">${money(p.price)}</td>
            <td class="right">${money(line)}</td>
          </tr>
        `;
      }).join("");

      cartTotalEl.textContent = money(calcCartTotal());
    }

    // Quantity controls inside modal
    cartRows.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-qty]");
      if(!btn) return;

      const id = btn.getAttribute("data-id");
      const type = btn.getAttribute("data-qty");
      const cart = loadCart();
      const product = PRODUCTS.find(p => p.item_id === id);
      if(!product) return;

      if(type === "inc"){
        cart[id] = (cart[id] || 0) + 1;
        saveCart(cart);

        // Optional: track add_to_cart when increasing qty
        gaEvent("add_to_cart", {
          currency: CURRENCY,
          value: product.price,
          items: [buildItem(product, 1)]
        });
      }

      if(type === "dec"){
        cart[id] = Math.max(0, (cart[id] || 0) - 1);
        if(cart[id] === 0) delete cart[id];
        saveCart(cart);

        // Optional: track remove_from_cart
        gaEvent("remove_from_cart", {
          currency: CURRENCY,
          value: product.price,
          items: [buildItem(product, 1)]
        });
      }

      renderCartTable();
    });

    viewCartBtn.addEventListener("click", () => openModal("view_cart"));
    beginCheckoutBtn.addEventListener("click", () => openModal("begin_checkout"));
    closeModalBtn.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => { if(e.target === backdrop) closeModal(); });

    clearCartBtn.addEventListener("click", () => {
      clearCart();
      showToast("Cart cleared");
    });

    // Simulated purchase
    placeOrderBtn.addEventListener("click", () => {
      const cart = loadCart();
      const entries = Object.entries(cart);
      if(entries.length === 0){
        showToast("Cart is empty");
        return;
      }

      const items = entries.map(([id, qty]) => {
        const p = PRODUCTS.find(x => x.item_id === id);
        return buildItem(p, qty);
      });

      const value = calcCartTotal();

      // For training: generate a fake transaction_id
      const transaction_id = "T" + Math.random().toString(16).slice(2, 10).toUpperCase();

      gaEvent("purchase", {
        transaction_id,
        affiliation: "Moonlit Fiction (Demo)",
        currency: CURRENCY,
        value,
        tax: 0,
        shipping: 0,
        coupon: "WINTER10",
        items
      });

      alert(
        `Order placed (simulated)!\n\n` +
        `transaction_id: ${transaction_id}\n` +
        `total: ${money(value)}\n\n` +
        `GA4: purchase fired`
      );

      clearCart();
      closeModal();
    });

    // Init render
    updateCartCount();
    renderProducts(getFilteredSorted());

    // Nice-to-have: homepage click scroll top
    document.getElementById("homeLink").addEventListener("click", (e) => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  </script>
</body>
</html>
